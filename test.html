<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°ì°¨ ê´€ë¦¬ AI ë¹„ì„œ (Anti-Hallucination)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #chat-container { width: 450px; height: 750px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        
        #header { background: #6655ff; color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; display: flex; flex-direction: column; gap: 5px; }
        .sub-header { font-size: 0.8rem; opacity: 0.9; font-weight: normal; margin-top: 5px; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 5px;}
        
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #f9f9fa; }
        .message { max-width: 80%; padding: 12px 16px; border-radius: 15px; font-size: 14px; line-height: 1.5; word-break: break-word; }
        
        .user { align-self: flex-end; background-color: #6655ff; color: white; border-bottom-right-radius: 2px; }
        .bot { align-self: flex-start; background-color: #ffffff; color: #333; border: 1px solid #e0e0e0; border-bottom-left-radius: 2px; }
        
        #input-area { display: flex; padding: 15px; background: #fff; border-top: 1px solid #eee; }
        #user-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; background-color: #f8f8f8; }
        #user-input:focus { border-color: #6655ff; background-color: #fff; }
        
        #send-btn { margin-left: 10px; width: 45px; height: 45px; background: #6655ff; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        #send-btn:hover { background: #5243cc; }
        #send-btn:disabled { background: #ccc; }
        
        .loading { font-size: 12px; color: #6655ff; text-align: center; margin-bottom: 10px; display: none; font-weight: bold; }
        
        .status-badge { display: inline-block; width: 10px; height: 10px; background: #ccc; border-radius: 50%; margin-right: 5px; }
        .status-active { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .status-error { background: #ff4444; }
    </style>
</head>
<body>

<div id="chat-container">
    <div id="header">
        <div>ì—°ì°¨ ê´€ë¦¬ AI ë¹„ì„œ</div>
        <div class="sub-header">
            <span id="status-light" class="status-badge"></span>
            <span id="file-status">íŒŒì¼ ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
        </div>
    </div>

    <div id="messages">
        <div class="message bot">
            ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹<br>
            <strong>'ì—°ì°¨ê³„íšì„œ.xlsx'</strong>ë¥¼ ì •ë°€ ë¶„ì„ ëª¨ë“œë¡œ ì½ê³  ìˆìŠµë‹ˆë‹¤.<br><br>
            ì´ì œ ì—†ëŠ” ë‚ ì§œë¥¼ ì§€ì–´ë‚´ì§€ ì•Šê³  ì •í™•í•˜ê²Œ ë‹µë³€í•©ë‹ˆë‹¤.
        </div>
    </div>
    
    <div id="loading" class="loading">ë°ì´í„° ë¶„ì„ ì¤‘... ğŸ”</div>
    
    <div id="input-area">
        <input type="text" id="user-input" placeholder="ì˜ˆ: 12ì›” 1ì¼ ì‰¬ëŠ” ì‚¬ëŒ ìˆì–´?" onkeypress="handleEnter(event)">
        <button id="send-btn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </div>
</div>

<script>
    const MODEL_NAME = "gemma3:12b"; 
    const EXCEL_FILE_NAME = "ì—°ì°¨ê³„íšì„œ.xlsx";
    
    let structuredData = ""; // LLMì—ê²Œ ë– ë¨¹ì—¬ì¤„ êµ¬ì¡°í™”ëœ ë°ì´í„°
    let isFileLoaded = false;

    window.onload = function() {
        loadExcelData();
    };

    async function loadExcelData() {
        const statusSpan = document.getElementById('file-status');
        const statusLight = document.getElementById('status-light');
        
        try {
            const response = await fetch(`./${EXCEL_FILE_NAME}`);
            if (!response.ok) throw new Error("CORS ë˜ëŠ” íŒŒì¼ ì—†ìŒ");

            const arrayBuffer = await response.arrayBuffer();
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(arrayBuffer);

            // ì¤‘ìš”: í™˜ê° ë°©ì§€ë¥¼ ìœ„í•´ Sheet1(ë‹¬ë ¥)ì€ ë¬´ì‹œí•˜ê³ , Sheet2(ë¦¬ìŠ¤íŠ¸)ë§Œ ì‚¬ìš©í•˜ì—¬ ì •í™•ë„ ë†’ì„
            const sheet2 = workbook.worksheets[1]; 
            
            // ë°ì´í„° êµ¬ì¡°í™” (JSON í˜•íƒœì˜ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜)
            structuredData = parseSheetToStructuredText(sheet2);

            isFileLoaded = true;
            statusSpan.innerText = "ì—°ë™ ì™„ë£Œ: ì •ë°€ ë¶„ì„ ëª¨ë“œ";
            statusLight.classList.add('status-active');
            addMessage(`âœ… <strong>ë¶„ì„ ì™„ë£Œ!</strong><br>
            ë°ì´í„°ë¥¼ ëª…ë‹¨ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë³€í™˜í–ˆìŠµë‹ˆë‹¤.<br>
            ì´ì œ "12ì›” 1ì¼" ì²˜ëŸ¼ ì—†ëŠ” ë‚ ì§œëŠ” í™•ì‹¤íˆ ì—†ë‹¤ê³  ëŒ€ë‹µí•©ë‹ˆë‹¤.`, "bot");

        } catch (error) {
            console.error(error);
            statusSpan.innerText = "íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨";
            statusLight.classList.add('status-error');
            addMessage(`âŒ <strong>ì˜¤ë¥˜ ë°œìƒ</strong><br>Live Serverë¡œ ì‹¤í–‰í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`, "bot");
        }
    }

    // ì—‘ì…€ ë°ì´í„°ë¥¼ "ì´ë¦„ - ë‚ ì§œ - ìƒíƒœ" ë¦¬ìŠ¤íŠ¸ë¡œ ê¹”ë”í•˜ê²Œ ì •ì œí•˜ëŠ” í•¨ìˆ˜
    function parseSheetToStructuredText(sheet) {
        if (!sheet) return "ë°ì´í„° ì—†ìŒ";

        let dataList = [];
        
        sheet.eachRow((row, rowNumber) => {
            if (rowNumber <= 1) return; // í—¤ë” ì œì™¸

            const nameCell = row.getCell(1);
            const name = nameCell.value ? String(nameCell.value).trim() : null;
            
            if (!name) return;

            row.eachCell((cell, colNumber) => {
                if (colNumber === 1) return; // ì´ë¦„ ì—´ ì œì™¸
                if (!cell.value) return; 

                const rawText = String(cell.value);
                let isRed = false;

                // ë¹¨ê°„ìƒ‰ ê°ì§€
                if (cell.font && cell.font.color && cell.font.color.argb) {
                    const colorHex = cell.font.color.argb;
                    if (colorHex.includes('FF0000') || colorHex.includes('FFFF0000')) {
                        isRed = true;
                    }
                }

                // ë‚ ì§œ í…ìŠ¤íŠ¸ ì •ê·œí™” (12.3 -> 12ì›” 3ì¼)
                // ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ìˆ«ì.ìˆ«ì íŒ¨í„´ì„ ì°¾ì•„ì„œ í•œê¸€ ë‚ ì§œë¡œ ë°”ê¿ˆ
                let normalizedDate = rawText;
                const dateMatch = rawText.match(/(\d{1,2})\.(\d{1,2})/);
                
                if (dateMatch) {
                    const month = dateMatch[1];
                    const day = dateMatch[2];
                    // "12ì›” 3ì¼" í˜•íƒœë¡œ ë³€í™˜ + ë’¤ì— ë¶™ì€ (5ì‹œê°„) ê°™ì€ í…ìŠ¤íŠ¸ ìœ ì§€
                    const extraText = rawText.replace(dateMatch[0], "").trim();
                    normalizedDate = `${month}ì›” ${day}ì¼${extraText}`;
                }

                // ìŠ¹ì¸ ì—¬ë¶€ ê²°ì •
                let status = "ìŠ¹ì¸ ì™„ë£Œ";
                if (isRed || rawText.includes("*") || rawText.includes("(ë¯¸)")) {
                    status = "ìŠ¹ì¸ ëŒ€ê¸°(ë¯¸ìŠ¹ì¸)";
                }

                // íŠ¹ìˆ˜ë¬¸ì ì œê±° í›„ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                const cleanDate = normalizedDate.replace(/[*()ë¯¸]/g, '').trim();
                
                // ë°ì´í„° í•œ ì¤„ ìƒì„±
                dataList.push(`- [ì´ë¦„: ${name}, ë‚ ì§œ: ${cleanDate}, ìƒíƒœ: ${status}]`);
            });
        });

        // ë¦¬ìŠ¤íŠ¸ë¥¼ í…ìŠ¤íŠ¸ë¡œ í•©ì¹¨
        return dataList.join("\n");
    }

    // ë‚ ì§œ ê³„ì‚° í•¨ìˆ˜ë“¤
    function getFormattedDate(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekDay = date.toLocaleString('ko-KR', { weekday: 'long' });
        return `${month}ì›” ${day}ì¼`; // í¬ë§·ì„ "12ì›” 1ì¼" ì²˜ëŸ¼ ì—‘ì…€ ë³€í™˜ ë°ì´í„°ì™€ ë§ì¶¤
    }

    async function sendMessage() {
        if (!isFileLoaded) {
            addMessage("íŒŒì¼ ë¡œë“œ ì „ì…ë‹ˆë‹¤.", "bot");
            return;
        }

        const inputField = document.getElementById("user-input");
        const sendBtn = document.getElementById("send-btn");
        const loading = document.getElementById("loading");
        const text = inputField.value.trim();
        if (!text) return;

        addMessage(text, "user");
        inputField.value = "";
        inputField.disabled = true;
        sendBtn.disabled = true;
        loading.style.display = "block";

        const now = new Date();
        const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1);
        const dayAfter = new Date(now); dayAfter.setDate(now.getDate() + 2);

        // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: ë°ì´í„°ì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ë§í•˜ì§€ ë§ë¼ê³  ê°•ë ¥ ì§€ì‹œ
        const systemPrompt = `
ë„ˆëŠ” íŒ©íŠ¸ ì²´í¬ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ í•˜ëŠ” ì¸ì‚¬ ë‹´ë‹¹ AIì•¼.

[ë‚ ì§œ ê¸°ì¤€ ì •ë³´]
- ì˜¤ëŠ˜: ${getFormattedDate(now)}
- ë‚´ì¼: ${getFormattedDate(tomorrow)}
- ëª¨ë ˆ: ${getFormattedDate(dayAfter)}

[í™•ì •ëœ ì—°ì°¨ ë°ì´í„°ë² ì´ìŠ¤]
ì•„ë˜ ëª©ë¡ì— **ìˆëŠ” ë‚ ì§œë§Œ** ì—°ì°¨ê°€ ìˆëŠ” ê±°ì•¼. ëª©ë¡ì— ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ "ì—°ì°¨ ì—†ìŒ"ì´ì•¼.
---------------------------------------------------
${structuredData}
---------------------------------------------------

[ë‹µë³€ ê·œì¹™ - ì ˆëŒ€ ì¤€ìˆ˜]
1. ì‚¬ìš©ìê°€ íŠ¹ì • ë‚ ì§œ(ì˜ˆ: 12ì›” 1ì¼)ë¥¼ ë¬¼ì–´ë³´ë©´, ìœ„ [í™•ì •ëœ ì—°ì°¨ ë°ì´í„°ë² ì´ìŠ¤]ì—ì„œ ê·¸ ë‚ ì§œê°€ í¬í•¨ëœ ì¤„ì„ ì°¾ì•„.
2. **ë§Œì•½ ë°ì´í„°ë² ì´ìŠ¤ì— ê·¸ ë‚ ì§œ(12ì›” 1ì¼)ê°€ ëª…ì‹œì ìœ¼ë¡œ ì íŒ ì¤„ì´ ì—†ë‹¤ë©´, ë°˜ë“œì‹œ "í•´ë‹¹ ë‚ ì§œì— ì—°ì°¨ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ëŒì€ ì—†ìŠµë‹ˆë‹¤."ë¼ê³  ë‹µí•´.** (ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ˆ!)
3. ë¹„ìŠ·í•œ ë‚ ì§œ(12ì›” 11ì¼ ë“±)ê°€ ìˆì–´ë„, ì‚¬ìš©ìê°€ ë¬¼ì–´ë³¸ ë‚ ì§œì™€ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì–¸ê¸‰í•˜ì§€ ë§ˆ.
4. ë‹µë³€ í˜•ì‹:
   - ìŠ¹ì¸ ì™„ë£Œ ì‹œ: "OOOë‹˜ì´ Oì›” Oì¼ì— ì—°ì°¨ë¥¼ **ì‚¬ìš©í•©ë‹ˆë‹¤.**"
   - ìŠ¹ì¸ ëŒ€ê¸° ì‹œ: "OOOë‹˜ì´ Oì›” Oì¼ì— ì—°ì°¨ë¥¼ **ì‚¬ìš©í•  ê³„íšì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.**"
`;

        try {
            const response = await fetch("http://localhost:11434/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    messages: [ 
                        { role: "system", content: systemPrompt }, 
                        { role: "user", content: text } 
                    ],
                    stream: false 
                })
            });

            if (!response.ok) throw new Error("Ollama ì—°ê²° ì‹¤íŒ¨");
            const data = await response.json();
            addMessage(data.message.content, "bot");

        } catch (error) {
            console.error(error);
            addMessage("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "bot");
        } finally {
            inputField.disabled = false;
            sendBtn.disabled = false;
            loading.style.display = "none";
            inputField.focus();
        }
    }

    function addMessage(text, sender) {
        const messagesDiv = document.getElementById("messages");
        const div = document.createElement("div");
        div.className = `message ${sender}`;
        div.innerHTML = text.replace(/\n/g, "<br>");
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function handleEnter(event) {
        if (event.key === "Enter") sendMessage();
    }
</script>
</body>
</html>